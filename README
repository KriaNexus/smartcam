/******************************************************************************
* Copyright (C) 2010 - 2020 Xilinx, Inc. All rights reserved.
* SPDX-License-Identifier: Apache-2.0
******************************************************************************/

0. Development Guide:
   If you want to build from source, follow these steps, otherwise skip this section.

   1) Install the SoM sdk.sh to the path you choose or default. Suppose SDKPATH.
   2) Run "./build.sh ${SDKPATH}" to build the somapp application.
   3) The build process in 2) will produce a rpm package SoMApp-1.0.1-1.aarch64.rpm under build/, upload to the board,
      and run "rmp -ivh --force ./SoMApp-1.0.1-1.aarch64.rpm" to update install.

The following file outlines the file structure and instructions on how to use
the AA1 application. This file outlines the HW requirements for the application,
how to run the application, and an overview of the application file structure. 

1. How to run the example application:
    A) Hardware and software set-up:
       a) Monitor:
          Before booting, connect the monitor to the board via either DP or HDMI port.
       b) IAS sensor:
          Before power on, install a AR1335 sensor module in J7.
       c) UART/JTAG interface:
          For interacting and seeing boot time information connect a USB debugger to the J4.
       d) You may also use a USB webcam as an input device. 
           The webcam is optional video input device supported in the application.
           Recommended is the Logitech BRIO.
       d) Network connection:
          Connect the Ethernet cable to your local network with DHCP enabled or a direct PC connection
          with a static IP configuration.
       e) RTSP client:
          You will use a PC having network access to the board as the RTSP client machine.
          On the client machine, to receive and play the RTSP stream, you need to install ffplay which is part of package FFmpeg.
            For Linux, you can install FFmpeg with the package manager of your distribution.
            For Windows, you can find install instructions on https://ffmpeg.org/download.html
            You may experience a lag of <1s, which maybe bigger / smaller if you use other RTSP clients.

    B) The accelerated application (AA) firmware consiting of bitstream, device tree overlay (dtbo), and xclbin
       file are loaded dynamically on user request once Linux is fully booted. The xmutil utility can be used
       for that purpose.

       a) To list the available AA applications, run:

            xmutil listapps

          You should see similar output to this:

            Accelerator,     Type,   Active
            kv260-aa2,       flat,   0
            kv260-aa1,       flat,   0

          The Active column shows which AA is currently loaded in the system. It will change to 1 after the
          firmware is loaded.

       b) To load the AA1 application firmware consisting of PL bitstream, device tree overlay and xclbin,
          run the following command:

            xmutil loadapp kv260-aa1

       c) After you are done running the application, you can unload the curently loaded AA application
          firmware by running:

            xmutil unloadapp

    C) Two methods of interacting with the application are provided.
       a) A Juypter notebook. Use a web-browser (e.g. Chrome, Firefox) to interact with the platform.
          i) The Jupyter notebook URL will be printed to the UART if the board is connected and allocated an IP address at boot. 
                Example: http://<board_ip_addr>:8888
          ii) If using a direct connection (no DHCP) see public documentation on how to configure your PC with a static IP on the same subnet. 
              For the SOM target set the desired IP address within the same subnet using ifconfig.
                Example: ifconfig eth0 10.0.1.15 netmask 255.255.255.0
              The notebook will be available at http://<your defined IP addr>:8888
       
       b) Command line scripts and configurations. These allow for the user to define different video input and output device targets using
          the "smartcam_aa1" application. These are to be executed using the UART/debug interface. Example scripts and configuration definitions 
          are provided below.

    D) Example scripts are provided on the system. For location see "File Structure"

       a) MIPI RTSP server:
         i) Invoking "01.mipi-rtsp.sh" will start rtsp server for mipi captured images
         ii) Script accepts ${width} ${height} as the 1st and 2nd parameter, the default is 1920 x 1080
         iii) Run "ffplay rtsp://boardip:5000/test" on the client PC to receive the rtsp stream.
                - if using a direct connection (no DHCP), see B)a)ii) above to configure a boardip before this step.
         iv) Checking:
            You should be able to see the images the camera is capturing on the ffplay window, and when there's face captured 
            by camera, there should be blue box drawn around the face, and the box should follow the movement of the face.

       b) MIPI DP display
         i) Make sure the monitor is connected as 0)-a).
         ii) Invoking "02.mipi-dp.sh" will play the captured video with detection results on monitor.
         iii) Script accepts ${width} ${height} as the 1st and 2nd parameter, the default is 1920 x 1080
         iv) Checking:
            You should be able to see the images the camera is capturing on the monitor connected to the board,  and when there's
            face captured by camera, there should be blue box drawn around the face, and the box should follow the movement of the face.

       c) File to File
         i) Invoking "03.file-to-file.sh"
         ii) Read in the sample video file from "/usr/share/somapp/movies/AA1/walking-people.nv12.30fps.1080p.h264",
            perform detection and generate video with detection bbox, save as ./out.h264
         iii) Checking:
            Play the input video file "/usr/share/somapp/movies/AA1/walking-people.nv12.30fps.1080p.h264" and generated video file 
            "./out.h264" with any media player you prefer, e.g. VLC, ffplay.
            You should be able to see in the output video file, there are blue boxes around the faces of walking people, and the boxes
            should follow the movement of the faces, while there's no such boxes with the input video file.
            
            
       d) File to DP
         i) Invoking "04.file-ssd-dp.sh"
         ii) Read in the sample video file from "/usr/share/somapp/movies/AA1/Road-Adas.nv12.30fps.1080p.h264",
            perform detection and generate video with detection bbox, and display onto moniter
         iii) Checking:
            You should be able to see a video of highway driving, with detection of vehicles in a bounding box.   

2. Additional configuration options for smartcam_aa1 invocation:
   The example scripts and Jupyter notebook work as examples to show capability of the smartcam_aa1 for specific configurations.
   More combinations could be made based on the options provided by smartcam_aa1.
   You can get detailed application options as following by invoking ./smartcam_aa1 --help.

    Usage:
      smartcam_aa1 [OPTION?] - Application for face detection on SOM board of Xilinx.
    
    Help Options:
      -h, --help                        Show help options
      --help-all                        Show all help options
      --help-gst                        Show GStreamer Options

    Application Options:
      -m, --mipi                        auto detect MIPI device
      -u, --usb=media_ID                usb camera media device id, e.g. 0 for /dev/media0
      -f, --file=file path              location of h26x file as input
      -i, --infile-type=h264            input file type: [h264 | h265]
      -W, --width=1920                  resolution w of the input
      -H, --height=1080                 resolution h of the input
      -r, --framerate=30                framerate of the input
      -t, --target=dp                   [dp|rtsp|file]
      -o, --outmedia-type=h264          output file type: [h264 | h265]
      -p, --port=5000                   Port to listen on (default: 5000)
      -a, --aitask                      select AI task to be run: [facedetect|ssd|refinedet]
      -n, --nodet                       no AI inference
      -R, --report                      report fps
      --ROI-off                         turn off ROI


   Example of supported combinations sorted by input are outlined below. If using command line to invoke
   the smartcam_aa1 stop the process via CTLR-C prior to starting the next instance.
   Note some of the configurations have functional limitations in EA1.
   have limitations:
   A) input MIPI (IAS sensor input):
      output: RTSP
        smartcam_aa1  --mipi -W 1920 -H 1080 --target rtsp >/dev/null 2>&1
      output: DP
        smartcam_aa1  --mipi -W 1920 -H 1080 --target dp >/dev/null 2>&1
      output: file
        smartcam_aa1  --mipi -W 1920 -H 1080 --target file >/dev/null 2>&1

   B) input file (file on file system):
      output: RTSP [!Not functional in EA1]
        smartcam_aa1  --file ./test.h264 -i h264 -W 1920 -H 1080 -r 30 --target rtsp >/dev/null 2>&1 
      output: DP [!Not functional in EA1]
        smartcam_aa1  --file ./test.h264 -i h264 -W 1920 -H 1080 -r 30 --target dp >/dev/null 2>&1
      output: file
        smartcam_aa1  --file ./test.h264 -i h264 -W 1920 -H 1080 -r 30 --target file >/dev/null 2>&1

      *Note you must update the command to the specific file desired as input source.

   C) input USB (USB webcam): [!Detection limitation with USB3.0 cameras]
      output: RTSP (USB - RTSP currently does not work - to be fixed)
        smartcam_aa1  --usb 1 -W 1920 -H 1080 -r 30 --target rtsp >/dev/null 2>&1      
      output: DP
        smartcam_aa1  --usb 1 -W 1920 -H 1080 -r 30 --target dp >/dev/null 2>&1
      output: file
        smartcam_aa1  --usb 1 -W 1920 -H 1080 -r 30 --target file >/dev/null 2>&1
      
      *You must ensure the width/height/framerate defined are supported by your USB camera.


3. File structure:
    The application is installed as:
        Binary File: => /opt/xilinx/bin
                                        smartcam_aa1         main app

        Script File: => /opt/xilinx/bin/
                                        setupmipi.sh         find mipi media number, to be used by smartcam_aa1.
                                        01.mipi-rtsp.sh      call smartcam_aa1 to run facedetction and send out rtsp stream.
                                        02.mipi-dp.sh        call smartcam_aa1 to run facedetction and display on DP display.
                                        03.file-file.sh      call smartcam_aa1 to run facedetction and display on input h264/5
                                                                  file and generate output h264/5 with detection boxes.
        configuration File: => /opt/xilinx/share/ivas
                                        kernel_boundingbox_facedetect.json
                                        kernel_densebox_640_360.json
                                        kernel_xpp_pipeline.json

    Jupyter notebook file:  => /usr/share/notebooks/smartcam_aa1
                                        AA1.ipynb
                                                             Jupyter notebook file for MIPI->RTSP demo.

    Example video files: => /opt/xilinx/share/video/AA1/
